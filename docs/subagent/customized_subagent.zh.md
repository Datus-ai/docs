# è‡ªå®šä¹‰ subagent

## ä»‹ç»

`.subagent` å‘½ä»¤æ˜¯ **Datus CLI** æä¾›çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç”¨äºç®¡ç†su'ba'gen'tã€‚æœ¬æ–‡æ¡£é‡ç‚¹ä»‹ç»å¦‚ä½•ä½¿ç”¨ `.subagent` åˆ›å»ºã€æŸ¥çœ‹ã€æ›´æ–°æˆ–åˆ é™¤subagentï¼Œå¹¶è¯¦ç»†è¯´æ˜å…¶å­å‘½ä»¤ã€‚`SubAgentBootstrapper` æ˜¯ `.subagent` å†…çš„åŠŸèƒ½æ¨¡å—ï¼Œç”¨äºä¸ºç‰¹å®šsubagentæ„å»ºæˆ–æ¨¡æ‹Ÿæ„å»º **èŒƒå›´åŒ–çŸ¥è¯†åº“**ï¼ˆScoped KBï¼‰ã€‚`.subagent` å‘½ä»¤æ”¯æŒsubagentçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå¹¶å¯è§¦å‘çŸ¥è¯†åº“æ„å»ºã€‚

---

## å‘½ä»¤æ¦‚è§ˆ

`.subagent` å‘½ä»¤æ”¯æŒä»¥ä¸‹å­å‘½ä»¤ï¼š

* **add** â€” å¯åŠ¨äº¤äº’å¼å‘å¯¼æ·»åŠ æ–°çš„subagentã€‚
* **list** â€” åˆ—å‡ºæ‰€æœ‰å·²é…ç½®çš„subagentã€‚
* **remove <agent_name>** â€” ä»é…ç½®ä¸­åˆ é™¤æŒ‡å®šçš„subagentã€‚
* **update <agent_name>** â€” å¯åŠ¨äº¤äº’å¼å‘å¯¼æ›´æ–°ç°æœ‰subagentã€‚
* **bootstrap <agent_name> [--components <list>] [--plan]** â€” ä¸ºç»™å®šsubagentæ„å»ºæˆ–æ¨¡æ‹Ÿæ„å»ºèŒƒå›´åŒ–çŸ¥è¯†åº“ã€‚

å¦‚æœæœªæä¾›å‚æ•°æˆ–æä¾›äº†é”™è¯¯çš„å‚æ•°ï¼Œå‘½ä»¤ä¼šè‡ªåŠ¨æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ã€‚

> **æ³¨æ„**ï¼šæ‰§è¡Œ `add` æˆ– `update` åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºsubagentæ„å»ºèŒƒå›´åŒ–çŸ¥è¯†åº“ã€‚

---

## å­å‘½ä»¤è¯¦è§£

### add â€” åˆ›å»ºæ–°subagent

è¿è¡Œï¼š

```bash
.subagent add
```

è¿™ä¼šå¯åŠ¨äº¤äº’å¼å‘å¯¼ï¼Œæç¤ºè¾“å…¥åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚subagentçš„ **åç§°ï¼ˆsystem_promptï¼‰**ã€**æè¿°**ã€**å·¥å…·**ã€**è§„åˆ™**ï¼Œä»¥åŠæ˜¯å¦éœ€è¦èŒƒå›´åŒ–ä¸Šä¸‹æ–‡ã€‚å®Œæˆåï¼Œé…ç½®æ–‡ä»¶ä¼šä¿å­˜åˆ°é¡¹ç›®ä¸­ï¼Œå¹¶å¯é€‰æ‹©ç”Ÿæˆç›¸åº”çš„æç¤ºæ¨¡æ¿æ–‡ä»¶ã€‚

å¦‚æœåˆ›å»ºè¿‡ç¨‹ä¸­é€”å–æ¶ˆï¼Œä¼šæ˜¾ç¤ºå–æ¶ˆæ¶ˆæ¯ï¼Œä¸ä¼šä¿å­˜ä»»ä½•é…ç½®ã€‚

![Add subagent](../assets/add_subagent.png)
> ğŸ’¡ **æç¤º**ï¼šåœ¨ç¬¬ä¸‰æ­¥ï¼ˆScopedContext é…ç½®ï¼‰ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ **Tab** è¿›è¡Œå±‚çº§è¡¥å…¨ï¼Œä½†é¢„è§ˆä¸å¯ç”¨ã€‚æŒ‰ **F2** å¯é¢„è§ˆã€‚

---

### list â€” åˆ—å‡ºæ‰€æœ‰subagent

è¿è¡Œï¼š

```bash
.subagent list
```

CLI ä¼šä»¥è¡¨æ ¼å½¢å¼æ˜¾ç¤ºæ‰€æœ‰å·²é…ç½®çš„subagentï¼ŒåŒ…å«ï¼š

* **åç§°ï¼ˆsystem_promptï¼‰**
* **èŒƒå›´åŒ–ä¸Šä¸‹æ–‡**ï¼šä¾‹å¦‚æ•°æ®è¡¨ã€æŒ‡æ ‡ã€SQL åˆ—è¡¨ï¼ˆå¦‚æœæ— åˆ™æ˜¾ç¤ºä¸ºç©ºï¼‰
* **èŒƒå›´åŒ–çŸ¥è¯†åº“è·¯å¾„**ï¼šæ˜¾ç¤ºèŒƒå›´åŒ–çŸ¥è¯†åº“ç›®å½•çš„è·¯å¾„ï¼ˆå¦‚æœä¸å¯ç”¨åˆ™æ˜¾ç¤º "â€”"ï¼‰
* **å·¥å…·**ï¼šsubagentä½¿ç”¨çš„å·¥å…·åˆ—è¡¨
* **MCP**ï¼šå¤šç»„ä»¶è¿›ç¨‹é…ç½®
* **è§„åˆ™**ï¼šä»¥ Markdown æ ¼å¼åˆ—å‡º

![List subagent](../assets/list_subagents.png)

å¦‚æœå½“å‰å‘½åç©ºé—´ä¸­æ²¡æœ‰subagentï¼ŒCLI ä¼šæ˜¾ç¤º `No configured subâ€‘agents`ã€‚

---

### remove â€” åˆ é™¤subagent

æ ¼å¼ï¼š

```bash
.subagent remove <agent_name>
```

åˆ é™¤æŒ‡å®šsubagentçš„é…ç½®ã€‚å¦‚æœæœªæ‰¾åˆ°ï¼Œä¼šæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ã€‚æˆåŠŸåˆ é™¤åï¼Œä¼šæ˜¾ç¤ºç¡®è®¤æ¶ˆæ¯ã€‚

---

### update â€” æ›´æ–°ç°æœ‰subagent

æ ¼å¼ï¼š

```bash
.subagent update <agent_name>
```

![Update subagent](../assets/update_subagent.png)

ç³»ç»Ÿé¦–å…ˆæ£€æŸ¥ç›®æ ‡subagentæ˜¯å¦å­˜åœ¨ã€‚å¦‚æœå­˜åœ¨ï¼Œä¼šå¯åŠ¨å‘å¯¼å¹¶é¢„å¡«å……ç°æœ‰é…ç½®ã€‚ç¡®è®¤æ›´æ–°åï¼Œé…ç½®ä¼šè¢«ä¿å­˜ã€‚å¦‚æœæ›´æ”¹å½±å“äº†èŒƒå›´åŒ–ä¸Šä¸‹æ–‡ï¼ŒCLI ä¼šè‡ªåŠ¨è§¦å‘ `bootstrap` é‡å»ºçŸ¥è¯†åº“ã€‚

---

### bootstrap â€” æ„å»ºèŒƒå›´åŒ–çŸ¥è¯†åº“

æ­¤å‘½ä»¤æ„å»ºæˆ–æ›´æ–°subagentçš„ **èŒƒå›´åŒ–çŸ¥è¯†åº“ï¼ˆScoped KBï¼‰**ã€‚å®ƒæ”¯æŒç»„ä»¶é€‰æ‹©å’Œè®¡åˆ’æ¨¡æ‹Ÿã€‚

#### åŸºæœ¬ç”¨æ³•

```bash
.subagent bootstrap <agent_name>
```

è¯¥å‘½ä»¤ä½¿ç”¨ `argparse.ArgumentParser`ï¼Œé€šè¿‡ `prog` å’Œ `description` å‚æ•°å®šä¹‰ç¨‹åºåç§°å’Œæè¿°ã€‚è¿è¡Œ `.subagent bootstrap -h` ä¼šæ˜¾ç¤ºè¯¦ç»†çš„å¸®åŠ©ä¿¡æ¯ã€‚

#### å‚æ•°

* `<agent_name>` â€” å¿…éœ€ã€‚æŒ‡å®šè¦ä¸ºå“ªä¸ªsubagentæ„å»ºçŸ¥è¯†åº“ã€‚
* `--components <list>` â€” å¯é€‰ã€‚è¦æ„å»ºçš„ç»„ä»¶åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼Œä¸åŒºåˆ†å¤§å°å†™ï¼‰ã€‚ç¤ºä¾‹ï¼š

  ```bash
  --components metadata,metrics
  ```

  å¦‚æœçœç•¥ï¼Œå°†æ„å»ºæ‰€æœ‰æ”¯æŒçš„ç»„ä»¶ã€‚æ— æ•ˆçš„ç»„ä»¶ä¼šè§¦å‘ `unsupported component` æç¤ºã€‚
* `--plan` â€” å¯é€‰æ ‡å¿—ã€‚åœ¨**è®¡åˆ’æ¨¡å¼**ä¸‹è¿è¡Œï¼Œè®¡ç®—å¹¶æ˜¾ç¤ºå¯¼å…¥è®¡åˆ’ä½†ä¸ä¼šå†™å…¥æˆ–ä¿®æ”¹æ–‡ä»¶ã€‚

#### å·¥ä½œæµ

1. **éªŒè¯å¹¶å®šä½subagent** â€” è§£æå‚æ•°å¹¶æ£€æŸ¥æŒ‡å®šçš„subagentæ˜¯å¦å­˜åœ¨ã€‚
2. **è§„èŒƒåŒ–ç»„ä»¶åˆ—è¡¨** â€” è½¬æ¢ä¸ºå°å†™å¹¶é’ˆå¯¹æ”¯æŒçš„ç»„ä»¶ï¼ˆä¾‹å¦‚ `metadata`ã€`metrics`ã€`reference_sql`ï¼‰è¿›è¡ŒéªŒè¯ã€‚æ— æ•ˆçš„ç»„ä»¶ä¼šè¢«æ‹’ç»ï¼Œå¹¶æ˜¾ç¤ºæ”¯æŒçš„åˆ—è¡¨ã€‚
3. **æ‰§è¡Œæˆ–æ¨¡æ‹Ÿæ„å»º**

   * ä¸ä½¿ç”¨ `--plan`ï¼šæ‰§è¡Œè¦†ç›–ç­–ç•¥ï¼Œå¯¼å…¥æ•°æ®åº“å…ƒæ•°æ®ã€æŒ‡æ ‡æˆ–å‚è€ƒ SQLï¼Œç”Ÿæˆæ–°çš„èŒƒå›´åŒ–çŸ¥è¯†åº“ç›®å½•ï¼Œå¹¶æ›´æ–°é…ç½®ã€‚
   * ä½¿ç”¨ `--plan`ï¼šä»…è¿è¡Œæ¨¡æ‹Ÿï¼Œè®¡ç®—è¦å¯¼å…¥çš„æ•°æ®è€Œä¸å†™å…¥æ–‡ä»¶ã€‚
4. **æ˜¾ç¤ºç»“æœ** â€” è¾“å‡ºæ‘˜è¦è¡¨æ ¼ï¼ˆ`Scoped KB Bootstrap Summary`ï¼‰ï¼ŒåŒ…å«åˆ—ï¼š

   * **Component** | **Status** | **Message**
   * çŠ¶æ€é€‰é¡¹ï¼š`SUCCESS`ã€`ERROR`ã€`SKIPPED`ã€`PLAN`
   * æ˜¾ç¤ºèŒƒå›´åŒ–çŸ¥è¯†åº“è·¯å¾„ â€” `Simulated scoped directory`ï¼ˆè®¡åˆ’æ¨¡å¼ï¼‰æˆ– `Scoped directory`ï¼ˆæ‰§è¡Œæ¨¡å¼ï¼‰ã€‚
5. **æ˜¾ç¤ºè¯¦æƒ…** â€” å¯¹äºç¼ºå¤±æˆ–æ— æ•ˆçš„è®°å½•ï¼Œåœ¨ `missing` å’Œ `invalid` å­—æ®µä¸‹æ˜¾ç¤º JSON è¯¦æƒ…ã€‚
6. **ä¿å­˜é…ç½®** â€” æˆåŠŸæ—¶ï¼ˆéè®¡åˆ’æ¨¡å¼ï¼‰ï¼Œæ›´æ–°subagenté…ç½®ä¸­çš„èŒƒå›´åŒ–çŸ¥è¯†åº“è·¯å¾„ã€‚ä¿å­˜è¿‡ç¨‹ä¸­çš„é”™è¯¯ä¼šè¢«æŠ¥å‘Šï¼›æˆåŠŸä¿å­˜ä¼šåˆ·æ–°å†…å­˜ä¸­çš„é…ç½®ã€‚

#### ç¤ºä¾‹

æ„å»ºæ‰€æœ‰ç»„ä»¶ï¼š

```bash
.subagent bootstrap my_agent
```

ä»…æ¨¡æ‹Ÿå…ƒæ•°æ®å’ŒæŒ‡æ ‡ï¼š

```bash
.subagent bootstrap my_agent --components metadata,metrics --plan
```

ä»…æ„å»ºå‚è€ƒ SQLï¼š

```bash
.subagent bootstrap my_agent --components reference_sql
```

---

## æ³¨æ„äº‹é¡¹

* **åç§°ä¸€è‡´æ€§**ï¼šsubagentåç§°ï¼ˆ`system_prompt`ï¼‰å”¯ä¸€æ ‡è¯†å…¶é…ç½®ã€‚ç¡®ä¿ `add`ã€`update`ã€`remove` å’Œ `bootstrap` å‘½ä»¤ä½¿ç”¨ä¸€è‡´çš„å‘½åã€‚
* **æ”¯æŒçš„ç»„ä»¶**ï¼šå¿…é¡»åœ¨é¢„å®šä¹‰çš„ç»„ä»¶ï¼ˆ`metadata`ã€`metrics`ã€`reference_sql`ï¼‰å†…ã€‚ä½¿ç”¨ `.subagent bootstrap -h` æ£€æŸ¥å¯ç”¨é€‰é¡¹ã€‚
* **æ¨¡æ‹Ÿæ¨¡å¼ï¼ˆ`--plan`ï¼‰**ï¼šç”¨äºé£é™©è¯„ä¼°ï¼›ä¸æ‰§è¡Œç£ç›˜å†™å…¥ã€‚çœç•¥æ­¤æ ‡å¿—ä»¥æ‰§è¡Œå®é™…æ„å»ºã€‚
* **è‡ªåŠ¨é‡å»º**ï¼šæ›´æ–°æ›´æ”¹èŒƒå›´åŒ–ä¸Šä¸‹æ–‡çš„subagentä¼šè‡ªåŠ¨è§¦å‘é‡å»ºï¼Œä»¥ä¿æŒé…ç½®å’ŒçŸ¥è¯†åº“çš„ä¸€è‡´æ€§ã€‚

---

## åœ¨ Agent ä¸­é‡å»ºsubagentçŸ¥è¯†åº“

è¿è¡Œï¼š

```bash
python -m datus.main bootstrap-kb
```

å½“å‰å‘½åç©ºé—´ä¸‹æ‰€æœ‰é…ç½®äº†èŒƒå›´åŒ–ä¸Šä¸‹æ–‡çš„subagentéƒ½ä¼šé‡å»ºå…¶çŸ¥è¯†åº“ã€‚æ„å»ºçš„å†…å®¹å–å†³äº `--component` å‚æ•°ã€‚

